// Javascript session functions, for handling login validation, tracking session expiry etc.
Biscuit.Session={remaining_time:null,check_timer:null,decrement_timer:null,display_remaining_timer:null,refresh_dialog_obj:null,login_dialog:null,KeepAlive:{ping_timer:null,ping:function(){Biscuit.Session.Extend(function(){Biscuit.Session.KeepAlive.ping_timer=setTimeout("Biscuit.Session.KeepAlive.ping();",6e4)})}},Extend:function(a){if(Biscuit.Session.remaining_time!=null){if(a==undefined){var a=function(){}}var b=new Date;var c=b.getTime();Biscuit.Ajax.Request("/ping/"+c,"ping",{success:function(){a()}})}},InitTracker:function(){if(this.remaining_time!=null){this.check_timer=setTimeout("Biscuit.Session.CheckExpiry();",1e3);this.decrement_timer=setTimeout("Biscuit.Session.DecrementTime();",1e3);$(document).ajaxError(function(a,b,c,d){var e=parseInt(b.getResponseHeader("X-Biscuit-Session-Time"));if(!isNaN(e)&&e>0){Biscuit.Session.remaining_time=e}});$(document).ajaxComplete(function(a,b,c){var d=parseInt(b.getResponseHeader("X-Biscuit-Session-Time"));if(!isNaN(d)&&d>0){Biscuit.Session.remaining_time=d}})}},CheckExpiry:function(){if(this.remaining_time<=120){this.ExpiryRefreshHandler()}else{this.check_timer=setTimeout("Biscuit.Session.CheckExpiry();",1e3)}},DecrementTime:function(){if(this.remaining_time>=0){this.remaining_time-=1;this.decrement_timer=setTimeout("Biscuit.Session.DecrementTime();",1e3)}},ExpiryRefreshHandler:function(){this.refresh_already_handled=true;clearTimeout(this.check_timer);clearTimeout(this.KeepAlive.ping_timer);var a="<h4><strong>"+__("login_expiry")+"</strong></h4>";var b="<strong>"+this.FormattedRemainingTime()+"</strong>";a+='<p id="session-time-remaining">'+__("login_time_remaining",[b])+"</p>";this.display_remaining_timer=setTimeout("Biscuit.Session.UpdateRemainingTimeDisplay();",1005);this.refresh_dialog_obj=Biscuit.Crumbs.Confirm(a,function(){clearTimeout(Biscuit.Session.display_remaining_timer);Biscuit.Session.Extend(function(){Biscuit.Session.check_timer=setTimeout("Biscuit.Session.CheckExpiry();",1e3)})},__("confirm_session_extend"),function(){clearTimeout(Biscuit.Session.display_remaining_timer);clearTimeout(Biscuit.Session.decrement_timer);Biscuit.Session.Logout(false)},__("cancel_session_extend"))},UpdateRemainingTimeDisplay:function(){if(this.remaining_time<0){this.refresh_dialog_obj.dialog("option","hide","").dialog("close");this.refresh_dialog_obj=null;this.LoginDialog()}else{var a="<strong>"+this.FormattedRemainingTime()+"</strong>";$("#session-time-remaining").html(__("login_time_remaining",[a]));this.display_remaining_timer=setTimeout("Biscuit.Session.UpdateRemainingTimeDisplay();",1e3)}},LoginDialog:function(){var a=Biscuit.Crumbs.LoadingBox(__("login_form_retrieving"));Biscuit.Ajax.Request("/login","update",{data:{login_dialog_request:1},type:"get",success:function(b){a.dialog("option","hide","").dialog("close");Biscuit.Session.login_dialog=Biscuit.Crumbs.Confirm('<h4 class="attention"><strong>'+__("login_dialog_title")+"</strong></h4>"+b,function(){Biscuit.Session.LoginDialogSubmit()},__("login"),function(){top.location.href=top.location.href});setTimeout("$('#login-form').submit(function() { Biscuit.Session.LoginDialogSubmit(); Biscuit.Session.login_dialog.dialog('option','hide','').dialog('close'); return false; });",250)},error:function(){a.dialog("option","hide","").dialog("close");Biscuit.Crumbs.Alert(__("login_form_retrieval_fail"))}})},LoginDialogSubmit:function(){var a=Biscuit.Crumbs.LoadingBox(__("checking_credentials"));var b=$("#login-form").serialize();b+="&login_dialog_request=1";Biscuit.Ajax.Request("/login","login",{data:b,type:"post",success:function(b){a.dialog("option","hide","").dialog("close");Biscuit.Session.remaining_time=b.remaining_session_time;this.decrement_timer=setTimeout("Biscuit.Session.DecrementTime();",1e3);Biscuit.Session.check_timer=setTimeout("Biscuit.Session.CheckExpiry();",1e3)},error:function(){a.dialog("option","hide","").dialog("close");Biscuit.Crumbs.Alert('<h4 class="attention"><strong>'+__("invalid_credentials")+"</strong></h4>",__("notice"),function(){Biscuit.Session.LoginDialog()},__("try_again"))}})},FormattedRemainingTime:function(){var a=0;var b=0;if(this.remaining_time>=60){a=Math.floor(this.remaining_time/60);b=this.remaining_time-a*60}else{a=0;b=this.remaining_time}if(a<10){a="0"+a}if(b<10){b="0"+b}return a+":"+b},Logout:function(a){var b=top.location.pathname;if(b=="/"){b=""}if(b.substr(0,1)!="/"&&b.length>0){b="/"+b}top.location.href=b+"/logout?js_auto_logout="+(a?1:0)}}
